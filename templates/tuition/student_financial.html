{% extends "base.html" %}
{% load static %}
{% block content %}
    {% include 'base/navigator.html' %}
    {% include 'spanel/student_aside.html' %}
    <main role="main" class="main-content">
        <div class="container-fluid">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %} alert-dismissible fade show"
                         role="alert">
                        {{ message|safe }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
            <div class="row justify-content-center">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="mb-2 page-title">{{ page_title }}</h2>
                            <p class="card-text text-muted">{{ page_description }}</p>
                        </div>
                        <button class="btn btn-primary" onclick="refreshFinancialData()">
                            <i class="fe fe-refresh-cw"></i>
                            <span class="d-none d-md-inline mr-2">بروزرسانی</span>
                        </button>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">در حال بارگذاری...</span>
                        </div>
                        <p class="mt-3 text-muted">در حال بارگذاری اطلاعات...</p>
                    </div>

                    <!-- Error Alert -->
                    <div id="errorAlert" class="alert alert-danger" style="display: none;" role="alert">
                        <i class="fe fe-alert-triangle"></i>
                        <span id="errorMessage"></span>
                    </div>

                    <!-- Financial Status Cards -->
                    <div id="financialContent" style="display: none;">
                        <!-- Main Status Card -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card shadow-sm border-0" id="mainStatusCard">
                                    <div class="card-body p-4">
                                        <div class="row align-items-center">
                                            <div class="col-12 col-md-8 mb-3 mb-md-0">
                                                <h5 class="text-muted mb-2">
                                                    <i class="fe fe-user-check"></i>
                                                    <span id="studentName">-</span>
                                                </h5>
                                                <h3 class="mb-1">وضعیت مالی جاری</h3>
                                                <div class="d-flex align-items-center flex-wrap">
                                                    <span class="badge badge-lg p-3 mr-2 mb-2" id="statusBadge">
                                                        <i class="fe fe-info"></i>
                                                        <span id="statusType">-</span>
                                                    </span>
                                                    <h2 class="mb-2 text-dark" id="currentAmount">
                                                        <span class="amount-number">-</span>
                                                        <small class="text-muted" style="font-size: 0.6em;">تومان</small>
                                                    </h2>
                                                </div>
                                            </div>
                                            <div class="col-12 col-md-4 text-center">
                                                <div class="position-relative" style="width: 150px; height: 150px; margin: 0 auto;">
                                                    <canvas id="financialChart"></canvas>
                                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                                        <i class="fe fe-dollar-sign" style="font-size: 3rem; opacity: 0.2;"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-12 col-md-4 mb-3">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="circle circle-lg bg-danger text-white mr-3">
                                                <i class="fe fe-trending-up"></i>
                                            </div>
                                            <div>
                                                <h6 class="text-muted mb-1">مجموع شهریه‌ها</h6>
                                                <h4 class="mb-0" id="totalDebt">
                                                    <span>-</span>
                                                    <small class="text-muted" style="font-size: 0.5em;">تومان</small>
                                                </h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="circle circle-lg bg-success text-white mr-3">
                                                <i class="fe fe-trending-down"></i>
                                            </div>
                                            <div>
                                                <h6 class="text-muted mb-1">مجموع پرداخت‌ها</h6>
                                                <h4 class="mb-0" id="totalPay">
                                                    <span>-</span>
                                                    <small class="text-muted" style="font-size: 0.5em;">تومان</small>
                                                </h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4 mb-3">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="circle circle-lg bg-info text-white mr-3">
                                                <i class="fe fe-list"></i>
                                            </div>
                                            <div>
                                                <h6 class="text-muted mb-1">تعداد پرداخت‌ها</h6>
                                                <h4 class="mb-0">
                                                    <span id="paymentsCount">-</span>
                                                    <small class="text-muted" style="font-size: 0.6em;">مورد</small>
                                                </h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payments List -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card shadow-sm border-0">
                                    <div class="card-header bg-white">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fe fe-list"></i>
                                                لیست پرداخت‌های من
                                            </h5>
                                            <div class="form-inline">
                                                <label class="mr-2 d-none d-md-inline">تعداد در صفحه:</label>
                                                <select class="form-control form-control-sm" id="perPageSelect">
                                                    <option value="5">5</option>
                                                    <option value="10" selected>10</option>
                                                    <option value="20">20</option>
                                                    <option value="50">50</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <!-- Loading for payments -->
                                        <div id="paymentsLoading" class="text-center py-4" style="display: none;">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="sr-only">در حال بارگذاری...</span>
                                            </div>
                                        </div>

                                        <!-- No payments message -->
                                        <div id="noPayments" class="text-center py-5" style="display: none;">
                                            <i class="fe fe-inbox" style="font-size: 4rem; opacity: 0.2;"></i>
                                            <p class="text-muted mt-3">هنوز پرداختی ثبت نشده است</p>
                                        </div>

                                        <!-- Payments Table -->
                                        <div class="table-responsive" id="paymentsTableContainer" style="display: none;">
                                            <table class="table table-hover mb-0">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th class="text-center d-none d-md-table-cell">#</th>
                                                        <th>مبلغ</th>
                                                        <th class="d-none d-md-table-cell">تاریخ</th>
                                                        <th class="d-none d-md-table-cell">نوع پرداخت</th>
                                                        <th class="d-none d-lg-table-cell">ترم</th>
                                                        <th class="d-none d-lg-table-cell">توضیحات</th>
                                                        <th class="d-md-none">جزئیات</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="paymentsTableBody">
                                                    <!-- Payments will be inserted here -->
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- Pagination -->
                                        <div class="card-footer bg-white" id="paginationContainer" style="display: none;">
                                            <div class="row align-items-center">
                                                <div class="col-12 col-md-6 mb-2 mb-md-0">
                                                    <p class="text-muted mb-0 small">
                                                        نمایش <span id="showingFrom">1</span> تا <span id="showingTo">10</span> 
                                                        از <span id="totalCount">0</span> پرداخت
                                                    </p>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <nav>
                                                        <ul class="pagination pagination-sm justify-content-end mb-0" id="paginationList">
                                                            <!-- Pagination buttons will be inserted here -->
                                                        </ul>
                                                    </nav>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock content %}

{% block moreScript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    let currentPage = 1;
    let perPage = 10;
    let financialChart = null;

    // Load financial status on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadFinancialStatus();
        loadPaymentsList();

        // Per page selector event
        document.getElementById('perPageSelect').addEventListener('change', function() {
            perPage = parseInt(this.value);
            currentPage = 1;
            loadPaymentsList();
        });
    });

    function refreshFinancialData() {
        loadFinancialStatus();
        loadPaymentsList();
    }

    function loadFinancialStatus() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('financialContent').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'none';

        fetch('/tuition/api/my-status/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('خطا در دریافت اطلاعات');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    updateFinancialUI(data);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('financialContent').style.display = 'block';
                } else {
                    showError(data.error || 'خطا در دریافت اطلاعات');
                }
            })
            .catch(error => {
                showError(error.message);
            });
    }

    function updateFinancialUI(data) {
        // Student name
        document.getElementById('studentName').textContent = data.student_name;

        // Status type and badge
        const statusBadge = document.getElementById('statusBadge');
        const statusType = document.getElementById('statusType');
        const mainCard = document.getElementById('mainStatusCard');
        
        statusType.textContent = data.status_type;
        
        // Remove old classes
        statusBadge.className = 'badge badge-lg p-3 mr-2 mb-2';
        mainCard.className = 'card shadow-sm border-0';
        
        // Add new classes based on status
        if (data.status_type === 'بدهکار') {
            statusBadge.classList.add('badge-danger');
            mainCard.classList.add('border-right-danger');
        } else if (data.status_type === 'بستانکار') {
            statusBadge.classList.add('badge-success');
            mainCard.classList.add('border-right-success');
        } else {
            statusBadge.classList.add('badge-info');
            mainCard.classList.add('border-right-info');
        }

        // Current amount
        document.querySelector('#currentAmount .amount-number').textContent = data.amount_formatted;

        // Summary cards
        document.querySelector('#totalDebt span').textContent = data.total_debt_formatted;
        document.querySelector('#totalPay span').textContent = data.total_pay_formatted;
        document.getElementById('paymentsCount').textContent = data.payments_count;

        // Update chart
        updateFinancialChart(data);
    }

    function updateFinancialChart(data) {
        const ctx = document.getElementById('financialChart').getContext('2d');
        
        if (financialChart) {
            financialChart.destroy();
        }

        const chartData = {
            labels: ['پرداخت شده', 'باقیمانده'],
            datasets: [{
                data: [data.total_pay, Math.max(0, data.account_balance)],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderWidth: 0
            }]
        };

        financialChart = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.toLocaleString('fa-IR') + ' تومان';
                                return label;
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
    }

    function loadPaymentsList(page = 1) {
        currentPage = page;
        document.getElementById('paymentsLoading').style.display = 'block';
        document.getElementById('paymentsTableContainer').style.display = 'none';
        document.getElementById('noPayments').style.display = 'none';
        document.getElementById('paginationContainer').style.display = 'none';

        fetch(`/tuition/api/my-payments/?page=${currentPage}&per_page=${perPage}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('خطا در دریافت لیست پرداخت‌ها');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    updatePaymentsList(data);
                } else {
                    showError(data.error || 'خطا در دریافت لیست پرداخت‌ها');
                }
            })
            .catch(error => {
                console.error('Error loading payments:', error);
                document.getElementById('paymentsLoading').style.display = 'none';
            });
    }

    function updatePaymentsList(data) {
        document.getElementById('paymentsLoading').style.display = 'none';

        if (data.payments.length === 0) {
            document.getElementById('noPayments').style.display = 'block';
            return;
        }

        // Show table
        document.getElementById('paymentsTableContainer').style.display = 'block';
        document.getElementById('paginationContainer').style.display = 'block';

        // Update table body
        const tbody = document.getElementById('paymentsTableBody');
        tbody.innerHTML = '';

        data.payments.forEach((payment, index) => {
            const rowNumber = (data.pagination.current_page - 1) * perPage + index + 1;
            const row = `
                <tr>
                    <td class="text-center d-none d-md-table-cell">${rowNumber}</td>
                    <td class="font-weight-bold text-success">
                        ${payment.amount_formatted} <small class="text-muted">تومان</small>
                        <div class="d-md-none small text-muted mt-1">
                            <div>${payment.pay_date}</div>
                            <div>${payment.pay_type}</div>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell">${payment.pay_date}</td>
                    <td class="d-none d-md-table-cell">
                        <span class="badge badge-soft-primary">${payment.pay_type}</span>
                    </td>
                    <td class="d-none d-lg-table-cell">${payment.term}</td>
                    <td class="d-none d-lg-table-cell">
                        <small class="text-muted">${payment.description}</small>
                    </td>
                    <td class="d-md-none">
                        <button class="btn btn-sm btn-outline-primary" onclick="showPaymentDetails(${payment.id}, '${payment.term}', '${payment.description}')">
                            <i class="fe fe-info"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // Update pagination info
        const showingFrom = (data.pagination.current_page - 1) * perPage + 1;
        const showingTo = Math.min(data.pagination.current_page * perPage, data.pagination.total_count);
        document.getElementById('showingFrom').textContent = showingFrom;
        document.getElementById('showingTo').textContent = showingTo;
        document.getElementById('totalCount').textContent = data.pagination.total_count;

        // Update pagination buttons
        updatePagination(data.pagination);
    }

    function updatePagination(pagination) {
        const paginationList = document.getElementById('paginationList');
        paginationList.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${!pagination.has_previous ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="loadPaymentsList(${pagination.previous_page}); return false;">
                <i class="fe fe-chevron-right"></i>
            </a>
        `;
        paginationList.appendChild(prevLi);

        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, pagination.current_page - Math.floor(maxPages / 2));
        let endPage = Math.min(pagination.total_pages, startPage + maxPages - 1);
        
        if (endPage - startPage + 1 < maxPages) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
            pageLi.innerHTML = `
                <a class="page-link" href="#" onclick="loadPaymentsList(${i}); return false;">
                    ${i}
                </a>
            `;
            paginationList.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="loadPaymentsList(${pagination.next_page}); return false;">
                <i class="fe fe-chevron-left"></i>
            </a>
        `;
        paginationList.appendChild(nextLi);
    }

    function showPaymentDetails(id, term, description) {
        alert(`جزئیات پرداخت:\n\nترم: ${term}\nتوضیحات: ${description}`);
    }

    function showError(message) {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('financialContent').style.display = 'none';
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }
</script>

<style>
    .border-right-danger {
        border-right: 4px solid #dc3545 !important;
    }
    .border-right-success {
        border-right: 4px solid #28a745 !important;
    }
    .border-right-info {
        border-right: 4px solid #17a2b8 !important;
    }
    .circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .circle-lg {
        width: 60px;
        height: 60px;
    }
    .badge-lg {
        font-size: 1rem;
    }
    .badge-soft-primary {
        background-color: rgba(78, 115, 223, 0.1);
        color: #4e73df;
    }
    @media (max-width: 768px) {
        .card-body {
            padding: 1rem !important;
        }
        .page-title {
            font-size: 1.5rem;
        }
        h4 {
            font-size: 1.2rem;
        }
    }
</style>
{% endblock moreScript %}

